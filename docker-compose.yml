---
version: '3.7'
services:
  db:
    image: postgres:11.6
    network_mode: "service:easilocal"
  db_migrate:
    build:
      context: .
      dockerfile: Dockerfile.db_migrations
    environment:
      - FLYWAY_USER=postgres
      - FLYWAY_PASSWORD=
      - FLYWAY_URL=jdbc:postgresql://localhost/postgres
        # volumes:
        #   - ./migrations:/flyway/sql
    network_mode: "service:easilocal"
    depends_on:
      - db
  easi:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - APPLICATION_VERSION
      - APPLICATION_DATETIME
      - APPLICATION_TS
      - APP_ENV=local
      - CLIENT_PROTOCOL=http
      - CLIENT_DOMAIN=localhost
      - CLIENT_PORT=3000
      - CLIENT_HOSTNAME=$CLIENT_DOMAIN:$CLIENT_PORT
      - CLIENT_ADDRESS=$CLIENT_PROTOCOL://$CLIENT_HOSTNAME
      - API_PORT=8080
      - REACT_APP_API_ADDRESS=$CLIENT_HOSTNAME:$API_PORT/api/v1
      - OKTA_CLIENT_ID=0oa2e913coDQeG19S297
      - REACT_APP_OKTA_CLIENT_ID=$OKTA_CLIENT_ID
      - REACT_APP_OKTA_DOMAIN=https://test.idp.idm.cms.gov
      - REACT_APP_OKTA_SERVER_ID=aus2e96etlbFPnBHt297
      - REACT_APP_OKTA_ISSUER=$REACT_APP_OKTA_DOMAIN/oauth2/$REACT_APP_OKTA_SERVER_ID
      - OKTA_ISSUER=$REACT_APP_OKTA_ISSUER
      - REACT_APP_OKTA_REDIRECT_URI=http://localhost:3000/implicit/callback
      - GRT_EMAIL=mikena@truss.works
      - AWS_REGION=us-west-2
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - AWS_SESSION_TOKEN
      - AWS_SES_SOURCE=no-reply-$APP_ENV@info.easi.cms.gov
      - AWS_SES_SOURCE_ARN
      - PGHOST=localhost
      - PGPORT=5432
      - PGDATABASE=postgres
      - PGUSER=postgres
      - PGPASS=""
      - PGSSLMODE=disable
    entrypoint: ["/easi/easi", "serve"]
    network_mode: "service:easilocal"
    depends_on:
      - db_migrate
  easilocal:
    build:
      context: .
      dockerfile: Dockerfile.client
      args:
        - REACT_APP_API_ADDRESS=http://localhost:8080/api/v1
        - REACT_APP_OKTA_CLIENT_ID=$OKTA_CLIENT_ID_DEV
        - REACT_APP_OKTA_DOMAIN=$OKTA_DOMAIN
        - REACT_APP_OKTA_ISSUER=$OKTA_ISSUER
        - REACT_APP_OKTA_REDIRECT_URI=http://localhost:3000/implicit/callback
        - REACT_APP_OKTA_SERVER_ID=$OKTA_SERVER_ID_DEV
    environment:
      - CI=true #https://github.com/facebook/create-react-app/issues/8688
    entrypoint: ["serve", "-s", "-l", "3000"]
  cypress:
    build:
      context: .
      dockerfile: Dockerfile.cypress
    environment:
      - OKTA_TEST_USERNAME
      - OKTA_TEST_PASSWORD
      - OKTA_TEST_SECRET
        # volumes:
        #   - ./cypress:/cypress
        #   - ./cypress.json:/cypress.json
        #   - ./tsconfig.json:/tsconfig.json
    network_mode: "service:easilocal"
    depends_on:
      - easilocal
