---
version: '3'
services:
  db:
    image: postgres:11.6
    ports:
      - 5432:5432
  db_migrate:
    build:
      context: .
      dockerfile: Dockerfile.db_migrations
    environment:
      - FLYWAY_USER=postgres
      - FLYWAY_PASSWORD=
      - FLYWAY_URL=jdbc:postgresql://db/postgres
    volumes:
      - ./migrations:/flyway/sql
    depends_on:
      - db
  easi:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - APPLICATION_VERSION=APPLICATION_VERSION
      - APPLICATION_DATETIME=APPLICATION_DATETIME
      - APPLICATION_TS=APPLICATION_TS
      - APP_ENV=local
      - CLIENT_PROTOCOL=CLIENT_PROTOCOL
      - CLIENT_DOMAIN=CLIENT_DOMAIN
      - CLIENT_PORT=CLIENT_PORT
      - CLIENT_HOSTNAME=CLIENT_HOSTNAME
      - CLIENT_ADDRESS=CLIENT_ADDRESS
      - API_PORT=8080
      - REACT_APP_API_ADDRESS=$CLIENT_HOSTNAME:$API_PORT/api/v1
      - OKTA_CLIENT_ID=0oa2e913coDQeG19S297
      - REACT_APP_OKTA_CLIENT_ID=$OKTA_CLIENT_ID
      - REACT_APP_OKTA_DOMAIN=https://test.idp.idm.cms.gov
      - REACT_APP_OKTA_SERVER_ID=aus2e96etlbFPnBHt297
      - REACT_APP_OKTA_ISSUER=$REACT_APP_OKTA_DOMAIN/oauth2/$REACT_APP_OKTA_SERVER_ID
      - OKTA_ISSUER=$REACT_APP_OKTA_ISSUER
      - REACT_APP_OKTA_REDIRECT_URI=http://localhost:3000/implicit/callback
      - EMAIL_TEMPLATE_DIR=EMAIL_TEMPLATE_DIR
      - GRT_EMAIL=GRT_EMAIL
      - AWS_REGION=AWS_REGION
      - AWS_ACCESS_KEY_ID=AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY=AWS_SECRET_ACCESS_KEY
      - AWS_SESSION_TOKEN=AWS_SESSION_TOKEN
      - AWS_SES_SOURCE=AWS_SES_SOURCE
      - AWS_SES_SOURCE_ARN=AWS_SES_SOURCE_ARN
    entrypoint: ["/easi/easi", "serve"]
    ports:
      - 8080:8080
    depends_on:
      - db_migrate
