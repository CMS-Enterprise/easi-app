#!/usr/bin/env bash
#
# build `easi` in docker and push to ECR
#

_tag_and_push() {
  # tag an image and push it up to the target repo
  declare image="$1"
  declare tag="$2:$3"

  if ( set -x ; docker tag "$image" "$tag" ) ; then
    ( set -x ; docker push "$tag" )
  else
    return
  fi
}

# log in to ECR
if bash +x -o nounset -c "$(aws ecr get-login --no-include-email --region "us-west-2" --registry-ids "${AWS_ACCOUNT_ID}")" ; then
  # build & tag the app image, then push to ECR
  APPLICATION_VERSION="${CIRCLE_SHA1:-"$(git rev-parse HEAD)"}"
  APPLICATION_DATETIME="$(date --rfc-3339='seconds' --utc)"
  APPLICATION_TS="$(date --date="$APPLICATION_DATETIME" '+%s')"
  ecr_backend="${AWS_ACCOUNT_ID}.dkr.ecr.us-west-2.amazonaws.com/easi-backend"
  builddir="$(git rev-parse --show-toplevel)"

  if docker build --build-arg ARG_APPLICATION_VERSION="$APPLICATION_VERSION" --build-arg ARG_APPLICATION_DATETIME="$APPLICATION_DATETIME" --build-arg ARG_APPLICATION_TS="$APPLICATION_TS" --no-cache --tag "easi" "$builddir" ; then
      _tag_and_push "easi:latest" "${ecr_backend}" "${APPLICATION_VERSION}" || exit
      _tag_and_push "easi:latest" "${ecr_backend}" "latest"  || exit
      _tag_and_push "easi:latest" "${ecr_backend}" "dev" || exit

      if [[ "$CIRCLE_BRANCH" = "master" ]]; then
        _tag_and_push "easi:latest" "${ecr_backend}" "impl" || exit
      fi
  else
    exit
  fi

else
  status=$?
  echo "FATAL: ECR login failed" 1>&2
  exit "$status"
fi
