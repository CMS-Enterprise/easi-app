#!/usr/bin/env bash

set -eu -o pipefail

if bash +x -o nounset -c "$(aws ecr get-login --no-include-email --region "us-west-2" --registry-ids "${AWS_ACCOUNT_ID}")" ; then
  docker-compose -f docker-compose.yml -f docker-compose.circleci.yml pull db_migrate backend

  docker-compose -f docker-compose.yml -f docker-compose.circleci.yml build --parallel frontend cypress

  docker-compose -f docker-compose.yml -f docker-compose.circleci.yml up -d db
  docker-compose -f docker-compose.yml -f docker-compose.circleci.yml up --exit-code-from db_migrate db_migrate
  docker-compose -f docker-compose.yml -f docker-compose.circleci.yml up -d backend frontend
  docker-compose -f docker-compose.yml -f docker-compose.circleci.yml up --exit-code-from cypress cypress
  echo "done"
else
  exit 1
fi
